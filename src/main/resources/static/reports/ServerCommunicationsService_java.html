<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Source Report for ServerCommunicationsService.java</title>
    <link href="resources/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="resources/css/windup.css" rel="stylesheet" media="screen"/>
    <link rel="stylesheet" type="text/css" href="resources/libraries/snippet/jquery.snippet.min.css" />
    <link rel="stylesheet" type="text/css" href="resources/css/windup-source.css" />
    <link rel="stylesheet" type="text/css" href="resources/libraries/sausage/sausage.css" />
    <link rel="shortcut icon" href="resources/img/rhamt-icon-128.png" type="image/x-icon"/>
</head>
<body role="document" class="source-report">

    <div class="navbar navbar-default navbar-fixed-top" id="main-navbar" style="display: none">
        <div class="wu-navbar-header navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <span class="wu-navbar-header">
              <strong class="wu-navbar-header">Red Hat Application Migration Toolkit</strong>
            </span>        </div>


                <div class="navbar-collapse collapse navbar-responsive-collapse project-specific" data-project-id="4062208">
    <ul class="nav navbar-nav">
            <li class="">
                <a href="../index.html"><i class="glyphicon glyphicon-home"></i> All Applications</a>
            </li>



                <li class="">
                    <a href="report_index_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-dashboard"></i>
                      Dashboard
                    </a>
                </li>


                <li class="">
                    <a href="migration_issues.1.html">
                        <i class="glyphicon glyphicon-warning-sign"></i>
                      Issues
                    </a>
                </li>


                <li class="">
                    <a href="ApplicationDetails_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-th-list"></i>
                      Application Details
                    </a>
                </li>


                <li class="">
                    <a href="dependency_report_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-compressed"></i>
                      Dependencies
                    </a>
                </li>


                <li class="">
                    <a href="remotereport_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon service-nav-logo"></i>
                      Remote Services
                    </a>
                </li>


                <li class="">
                    <a href="ejbreport_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon ejb-nav-logo"></i>
                      EJBs
                    </a>
                </li>


                <li class="">
                    <a href="jpa_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon jpa-nav-logo"></i>
                      JPA
                    </a>
                </li>


                <li class="">
                    <a href="server_resources_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon server-resource-nav-logo"></i>
                      Server Resources
                    </a>
                </li>


                <li class="">
                    <a href="hardcoded_ipsRHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-map-marker"></i>
                      Hard-coded IP Addresses
                    </a>
                </li>


                <li class="">
                    <a href="ignoredfiles_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-eye-close"></i>
                      Ignored Files
                    </a>
                </li>


                <li class="">
                    <a href="about_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-info-sign"></i>
                      About
                    </a>
                </li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
<li>
    <a href="#" class="feedback-nav-btn jiraFeedbackTrigger"><i class="glyphicon glyphicon-comment"></i> Send Feedback </a>
</li>


    <script type="text/javascript" src="https://issues.jboss.org/s/f215932e68571747ac58d0f5d554396f-T/en_US-r7luaf/6346/82/1.4.16/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-US&amp;collectorId=8b9e338b"></script>

    <script type="text/javascript">

    var FEEDBACK_JS_ADDED = false;
    var FEEDBACK_FORM_TRIGGER = null;

    function displayFeedbackForm() {
        FEEDBACK_FORM_TRIGGER();
    }

    window.ATL_JQ_PAGE_PROPS = {
        "triggerFunction": function(showCollectorDialog) {
            FEEDBACK_FORM_TRIGGER = showCollectorDialog;
        }
    };

    document.addEventListener("DOMContentLoaded", function(event) {
            jQuery(".jiraFeedbackTrigger").click(function(e) {
                e.preventDefault();
                displayFeedbackForm();
            });
    });
    </script>
    </ul>
                </div><!-- /.nav-collapse -->
    </div>


    <div class="container-fluid" role="main">
        <div class="row">
            <div class="page-header page-header-no-border">
                <h1>
                    <div class="main">Source Report</div>

                        <div class="path project-specific" data-project-id="4062208">
                            rhq-enterprise-server-ear-1.3.0.EmbJopr.1.3.0-4.ear/rhq-enterprise-server-ejb3.jar/org/rhq/enterprise/server/core/comm/ServerCommunicationsService.java
                        </div>
                </h1>
                <div class="desc">
                    This report displays what Red Hat Application Migration Toolkit found in individual files.
                    Each item is shown below the line it was found on,
                    and next to it, you may find a link to the rule which it was found by.
                </div>
            </div>
        </div>

        <div class="row">
            <div class="container-fluid theme-showcase" role="main">

                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Information</h3>
                    </div>
                    <div class="panel-body" style="overflow: auto;">

                        <!--<div style="height: 120pt; float:left;"></div> Keeps the minimal height. -->
                        <div class="points" style="text-align: center; color: #00254b; padding-bottom: 1ex;">
                            <div class="number">1</div>
                            <div>Story Points</div>
                        </div>

                        <div class="info" style="margin-left: 95pt;">

                            <h4>Technologies</h4>
                            <div class="technologies" style="overflow: auto"><!-- "auto" to contain all the tags. -->
                                    <span class="label label-info" title="INFORMATIONAL">Decompiled Java File</span>
                            </div>



                            <div style="clear: both;"/><!-- Snaps under the height keeper. Yes, the same effect could be achieved by a table. -->
                        </div><!-- .info -->
                    </div>
                </div>



                <pre id="source">
package org.rhq.enterprise.server.core.comm;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Map.Entry;
import java.util.prefs.Preferences;
import javax.management.MBeanRegistration;
import javax.management.MBeanServer;
import javax.management.MBeanServerInvocationHandler;
import javax.management.ObjectName;
import mazz.i18n.Logger;
import org.jboss.remoting.InvokerLocator;
import org.jboss.system.server.ServerConfig;
import org.jboss.util.StringPropertyReplacer;
import org.rhq.core.domain.cloud.Server;
import org.rhq.core.domain.resource.Agent;
import org.rhq.core.util.ObjectNameFactory;
import org.rhq.core.util.PropertiesFileUpdate;
import org.rhq.core.util.exception.ThrowableUtil;
import org.rhq.enterprise.communications.Ping;
import org.rhq.enterprise.communications.ServiceContainer;
import org.rhq.enterprise.communications.ServiceContainerConfiguration;
import org.rhq.enterprise.communications.ServiceContainerMetricsMBean;
import org.rhq.enterprise.communications.command.client.ClientCommandSender;
import org.rhq.enterprise.communications.command.client.ClientCommandSenderConfiguration;
import org.rhq.enterprise.communications.command.client.ClientRemotePojoFactory;
import org.rhq.enterprise.communications.util.ConcurrencyManager;
import org.rhq.enterprise.communications.util.SecurityUtil;
import org.rhq.enterprise.server.agentclient.AgentClient;
import org.rhq.enterprise.server.agentclient.impl.AgentClientImpl;
import org.rhq.enterprise.server.core.comm.KnownAgents;
import org.rhq.enterprise.server.core.comm.ServerAutoDiscoveryListener;
import org.rhq.enterprise.server.core.comm.ServerCommunicationsServiceMBean;
import org.rhq.enterprise.server.core.comm.ServerConfiguration;
import org.rhq.enterprise.server.core.comm.ServerConfigurationUpgrade;
import org.rhq.enterprise.server.core.comm.ServerI18NFactory;
import org.rhq.enterprise.server.remote.RemoteSafeInvocationHandler;
import org.rhq.enterprise.server.remote.RemoteWsInvocationHandler;
import org.rhq.enterprise.server.util.LookupUtil;

public class ServerCommunicationsService implements ServerCommunicationsServiceMBean, MBeanRegistration {
   private static Logger LOG = ServerI18NFactory.getLogger(ServerCommunicationsService.class);
   private static final String REMOTE_API_SUBSYSTEM = &quot;REMOTEAPI&quot;;
   private static final String WS_REMOTE_API_SUBSYSTEM = &quot;WSREMOTEAPI&quot;;
   private MBeanServer m_mbs = null;
   private ServiceContainer m_container = null;
   private ServerConfiguration m_configuration = null;
   private String m_configFile = &quot;server-comm-configuration.xml&quot;;
   private String m_preferencesNodeName = &quot;default&quot;;
   private Properties m_configurationOverrides = null;
   private KnownAgents m_knownAgents = new KnownAgents();
   private Map m_knownAgentClients = new HashMap();
   private File m_serverPropertiesFile = null;
   private boolean m_started = false;
   private RemoteSafeInvocationHandler m_remoteApiHandler;
   private RemoteWsInvocationHandler m_remoteWsApiHandler;

   public ObjectName preRegister(MBeanServer mbs, ObjectName name) throws Exception {
      this.m_mbs = mbs;
      return name;
   }

   public void postRegister(Boolean arg0) {
   }

   public synchronized void startCommunicationServices() throws Exception {
      if(!this.m_started) {
         ServerConfiguration config = this.reloadConfiguration();
         ServiceContainer container = null == this.m_container?new ServiceContainer():this.m_container;
         ServerAutoDiscoveryListener listener = new ServerAutoDiscoveryListener(this.m_knownAgents);
         container.addDiscoveryListener(listener);
         container.start(config.getServiceContainerPreferences().getPreferences(), config.getClientCommandSenderConfiguration(), this.m_mbs);
         this.m_remoteApiHandler = new RemoteSafeInvocationHandler();
         this.m_remoteApiHandler.registerMetricsMBean(container.getMBeanServer());
         container.addInvocationHandler(&quot;REMOTEAPI&quot;, this.m_remoteApiHandler);
         this.m_remoteWsApiHandler = new RemoteWsInvocationHandler();
         container.addInvocationHandler(&quot;WSREMOTEAPI&quot;, this.m_remoteWsApiHandler);
         this.m_container = container;
         this.m_configuration = config;
         this.m_started = true;
      }

   }

   public synchronized void stop() {
      if(this.m_container != null) {
         try {
            this.m_remoteApiHandler.unregisterMetricsMBean(this.m_container.getMBeanServer());
            this.m_container.removeInvocationHandler(&quot;REMOTEAPI&quot;);
            this.m_container.removeInvocationHandler(&quot;WSREMOTEAPI&quot;);
         } catch (Exception var5) {
            LOG.warn(&quot;ServerCommunicationsService.remote-api-removal-failure&quot;, new Object[]{ThrowableUtil.getAllMessages(var5)});
         }

         this.m_container.shutdown();
         this.m_container = null;
         this.m_remoteApiHandler = null;
         this.m_remoteWsApiHandler = null;
         this.m_started = false;
      }

      Map e = this.m_knownAgentClients;
      synchronized(this.m_knownAgentClients) {
         Iterator i$ = this.m_knownAgentClients.values().iterator();

         while(i$.hasNext()) {
            AgentClient client = (AgentClient)i$.next();
            client.stopSending();
         }

         this.m_knownAgentClients.clear();
      }
   }

   public boolean isStarted() {
      return this.m_started;
   }

   public void preDeregister() throws Exception {
   }

   public void postDeregister() {
      this.m_mbs = null;
      this.m_container = null;
      this.m_configuration = null;
      this.m_configFile = &quot;server-comm-configuration.xml&quot;;
      this.m_preferencesNodeName = &quot;default&quot;;
      this.m_configurationOverrides = null;
      this.m_knownAgents.removeAllAgents();
      this.m_knownAgentClients.clear();
      this.m_started = false;
   }

   public String getConfigurationFile() {
      return this.m_configFile;
   }

   public void setConfigurationFile(String location) {
      this.m_configFile = StringPropertyReplacer.replaceProperties(location);
   }

   public String getPreferencesNodeName() {
      return this.m_preferencesNodeName;
   }

   public void setPreferencesNodeName(String node) {
      this.m_preferencesNodeName = node;
   }

   public Properties getConfigurationOverrides() {
      return this.m_configurationOverrides;
   }

   public void setConfigurationOverrides(Properties overrides) {
      this.m_configurationOverrides = overrides;
   }

   public ServerConfiguration reloadConfiguration() throws Exception {
      this.getPreferencesNode().clear();
      return this.prepareConfigurationPreferences();
   }

   public ServerConfiguration getConfiguration() {
      return this.m_configuration;
   }

   public synchronized ServiceContainer safeGetServiceContainer() {
      if(null == this.m_container) {
         this.m_container = new ServiceContainer();
      }

      return this.m_container;
   }

   public ServiceContainer getServiceContainer() {
      return this.m_container;
   }

   public String getStartedServerEndpoint() {
      return this.m_container == null?null:this.m_container.getServerEndpoint();
   }

   public AgentClient getKnownAgentClient(Agent agent) {
      if(agent == null) {
         throw new IllegalStateException(&quot;Agent must be non-null - is a resource not assigned an agent?&quot;);
      } else {
         Map var3 = this.m_knownAgentClients;
         synchronized(this.m_knownAgentClients) {
            String agent_address = agent.getAddress();
            int agent_port = agent.getPort();
            Object agent_client = (AgentClient)this.m_knownAgentClients.get(this.getEndpointKey(agent_address, agent_port));
            if(agent_client == null) {
               InvokerLocator locator = this.m_knownAgents.getAgent(agent_address, agent_port);
               String remote_uri;
               if(locator != null) {
                  remote_uri = locator.getLocatorURI();
               } else {
                  remote_uri = agent.getRemoteEndpoint();
                  if(remote_uri == null) {
                     remote_uri = &quot;socket://&quot; + agent_address + &quot;:&quot; + agent_port;
                  }
               }

               ClientCommandSenderConfiguration client_config = this.getSenderConfiguration(agent);
               ClientCommandSender sender = this.getServiceContainer().createClientCommandSender(remote_uri, client_config);
               agent_client = new AgentClientImpl(agent, sender);
               this.m_knownAgentClients.put(this.getEndpointKey(agent_address, agent_port), agent_client);
            }

            return (AgentClient)agent_client;
         }
      }
   }

   public void destroyKnownAgentClient(Agent agent) {
      Map var3 = this.m_knownAgentClients;
      synchronized(this.m_knownAgentClients) {
         String agent_address = agent.getAddress();
         int agent_port = agent.getPort();
         AgentClient agent_client = (AgentClient)this.m_knownAgentClients.remove(this.getEndpointKey(agent_address, agent_port));
         if(agent_client != null) {
            agent_client.stopSending();
         }

         File spool_file = null;

         try {
            ClientCommandSenderConfiguration e = this.getSenderConfiguration(agent);
            spool_file = new File(e.dataDirectory, e.commandSpoolFileName);
            if(spool_file.exists()) {
               (new FileOutputStream(spool_file, false)).close();
               spool_file.delete();
            }
         } catch (Exception var9) {
            LOG.warn(&quot;Failed to truncate/delete spool for deleted agent [&quot; + agent + &quot;]&quot; + &quot; please manually remove the file: &quot; + spool_file, new Object[]{var9});
         }

      }
   }

   public List getAllKnownAgents() {
      return this.m_knownAgents.getAllAgents();
   }

   public void addStartedAgent(Agent agent) {
      String endpoint = agent.getRemoteEndpoint();
      this.m_knownAgents.addAgent(endpoint);
      AgentClient client = this.getKnownAgentClient(agent);
      if(client != null) {
         client.startSending();
      }

   }

   public void removeDownedAgent(String endpoint) {
      this.m_knownAgents.removeAgent(endpoint);

      InvokerLocator locator;
      try {
         locator = new InvokerLocator(endpoint);
      } catch (MalformedURLException var7) {
         throw new IllegalArgumentException(var7);
      }

      Map e = this.m_knownAgentClients;
      AgentClient client;
      synchronized(this.m_knownAgentClients) {
         client = (AgentClient)this.m_knownAgentClients.remove(this.getEndpointKey(locator.getHost(), locator.getPort()));
      }

      if(client != null) {
         client.stopSending();
      }

   }

   public boolean pingEndpoint(String endpoint, long timeoutMillis) {
      ClientCommandSender sender = null;
      boolean pinged = false;

      try {
         ServerConfiguration e = this.getConfiguration();
         ClientCommandSenderConfiguration client_config = e.getClientCommandSenderConfiguration();
         client_config.commandSpoolFileName = null;
         client_config.enableQueueThrottling = false;
         client_config.enableSendThrottling = false;
         client_config.serverPollingIntervalMillis = -1L;
         sender = this.getServiceContainer().createClientCommandSender(endpoint, client_config);
         sender.startSending();
         ClientRemotePojoFactory factory = sender.getClientRemotePojoFactory();
         factory.setTimeout(Long.valueOf(timeoutMillis));
         Ping pinger = (Ping)factory.getRemotePojo(Ping.class);
         pinger.ping(&quot;&quot;, (String)null);
         boolean var10 = true;
         return var10;
      } catch (Exception var14) {
         LOG.debug(&quot;ServerCommunicationsService.ping-failed&quot;, new Object[]{endpoint, ThrowableUtil.getAllMessages(var14, true)});
         pinged = false;
      } finally {
         if(sender != null) {
            sender.stopSending(false);
         }

      }

      return pinged;
   }

   public Integer getGlobalConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConfiguration().getGlobalConcurrencyLimit());
   }

   public void setGlobalConcurrencyLimit(Integer maxConcurrency) {
      if(maxConcurrency == null) {
         maxConcurrency = Integer.valueOf(-1);
      }

      this.setConcurrencyLimit(&quot;rhq.communications.global-concurrency-limit-semaphore&quot;, maxConcurrency, false);
      this.persistServerProperty(&quot;rhq.communications.global-concurrency-limit&quot;, String.valueOf(maxConcurrency));
      this.getServiceContainer().getConfiguration().getPreferences().putInt(&quot;rhq.communications.global-concurrency-limit&quot;, maxConcurrency.intValue());
   }

   public Integer getInventoryReportConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConcurrencyManager().getConfiguredNumberOfPermitsAllowed(&quot;rhq.server.concurrency-limit.inventory-report&quot;));
   }

   public void setInventoryReportConcurrencyLimit(Integer maxConcurrency) {
      this.setConcurrencyLimit(&quot;rhq.server.concurrency-limit.inventory-report&quot;, maxConcurrency, true);
   }

   public Integer getAvailabilityReportConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConcurrencyManager().getConfiguredNumberOfPermitsAllowed(&quot;rhq.server.concurrency-limit.availability-report&quot;));
   }

   public void setAvailabilityReportConcurrencyLimit(Integer maxConcurrency) {
      this.setConcurrencyLimit(&quot;rhq.server.concurrency-limit.availability-report&quot;, maxConcurrency, true);
   }

   public Integer getInventorySyncConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConcurrencyManager().getConfiguredNumberOfPermitsAllowed(&quot;rhq.server.concurrency-limit.inventory-sync&quot;));
   }

   public void setInventorySyncConcurrencyLimit(Integer maxConcurrency) {
      this.setConcurrencyLimit(&quot;rhq.server.concurrency-limit.inventory-sync&quot;, maxConcurrency, true);
   }

   public Integer getContentReportConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConcurrencyManager().getConfiguredNumberOfPermitsAllowed(&quot;rhq.server.concurrency-limit.content-report&quot;));
   }

   public void setContentReportConcurrencyLimit(Integer maxConcurrency) {
      this.setConcurrencyLimit(&quot;rhq.server.concurrency-limit.content-report&quot;, maxConcurrency, true);
   }

   public Integer getContentDownloadConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConcurrencyManager().getConfiguredNumberOfPermitsAllowed(&quot;rhq.server.concurrency-limit.content-download&quot;));
   }

   public void setContentDownloadConcurrencyLimit(Integer maxConcurrency) {
      this.setConcurrencyLimit(&quot;rhq.server.concurrency-limit.content-download&quot;, maxConcurrency, true);
   }

   public Integer getMeasurementReportConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConcurrencyManager().getConfiguredNumberOfPermitsAllowed(&quot;rhq.server.concurrency-limit.measurement-report&quot;));
   }

   public void setMeasurementReportConcurrencyLimit(Integer maxConcurrency) {
      this.setConcurrencyLimit(&quot;rhq.server.concurrency-limit.measurement-report&quot;, maxConcurrency, true);
   }

   public Integer getMeasurementScheduleRequestConcurrencyLimit() {
      return Integer.valueOf(this.getServiceContainer().getConcurrencyManager().getConfiguredNumberOfPermitsAllowed(&quot;rhq.server.concurrency-limit.measurement-schedule-request&quot;));
   }

   public void setMeasurementScheduleRequestConcurrencyLimit(Integer maxConcurrency) {
      this.setConcurrencyLimit(&quot;rhq.server.concurrency-limit.measurement-schedule-request&quot;, maxConcurrency, true);
   }

   public Boolean getMaintenanceModeAtStartup() {
      FileInputStream inputStream = null;

      Boolean flag;
      try {
         File ignored = this.getServerPropertiesFile();
         Properties props = new Properties();
         inputStream = new FileInputStream(ignored);
         props.load(inputStream);
         flag = Boolean.valueOf(Boolean.parseBoolean(props.getProperty(&quot;rhq.server.maintenance-mode-at-startup&quot;, &quot;false&quot;)));
      } catch (Exception var13) {
         LOG.error(&quot;Cannot read MM-on-startup property from file, will use the sysprop instead&quot;, new Object[]{var13});
         flag = Boolean.valueOf(Boolean.getBoolean(&quot;rhq.server.maintenance-mode-at-startup&quot;));
      } finally {
         if(inputStream != null) {
            try {
               inputStream.close();
            } catch (Exception var12) {
               ;
            }
         }

      }

      return flag;
   }

   public Boolean isMaintenanceModeAtStartup() {
      return this.getMaintenanceModeAtStartup();
   }

   public void setMaintenanceModeAtStartup(Boolean flag) {
      if(flag == null) {
         flag = Boolean.FALSE;
      }

      this.persistServerProperty(&quot;rhq.server.maintenance-mode-at-startup&quot;, flag.toString());
      System.setProperty(&quot;rhq.server.maintenance-mode-at-startup&quot;, flag.toString());
   }

   public void clear() {
      this.getServiceContainerMetricsMBean().clear();
   }

   public long getNumberDroppedCommandsReceived() {
      return this.getServiceContainerMetricsMBean().getNumberDroppedCommandsReceived();
   }

   public long getNumberNotProcessedCommandsReceived() {
      return this.getServiceContainerMetricsMBean().getNumberNotProcessedCommandsReceived();
   }

   public long getNumberFailedCommandsReceived() {
      return this.getServiceContainerMetricsMBean().getNumberFailedCommandsReceived();
   }

   public long getNumberSuccessfulCommandsReceived() {
      return this.getServiceContainerMetricsMBean().getNumberSuccessfulCommandsReceived();
   }

   public long getNumberTotalCommandsReceived() {
      return this.getServiceContainerMetricsMBean().getNumberTotalCommandsReceived();
   }

   public long getAverageExecutionTimeReceived() {
      return this.getServiceContainerMetricsMBean().getAverageExecutionTimeReceived();
   }

   public Map getCallTimeDataReceived() {
      return this.getServiceContainerMetricsMBean().getCallTimeDataReceived();
   }

   private ServiceContainerMetricsMBean getServiceContainerMetricsMBean() {
      MBeanServer mbs = this.getServiceContainer().getMBeanServer();
      Object proxy = MBeanServerInvocationHandler.newProxyInstance(mbs, ServiceContainerMetricsMBean.OBJECTNAME_METRICS, ServiceContainerMetricsMBean.class, false);
      return (ServiceContainerMetricsMBean)proxy;
   }

   private String getEndpointKey(String host, int port) {
      return host + &quot;:&quot; + port;
   }

   private ClientCommandSenderConfiguration getSenderConfiguration(Agent agent) {
      ServerConfiguration server_config = this.getConfiguration();
      ClientCommandSenderConfiguration client_config = server_config.getClientCommandSenderConfiguration();
      if(client_config.commandSpoolFileName != null) {
         File spool_file = new File(client_config.commandSpoolFileName);
         String file_name = spool_file.getName();
         String parent_path = spool_file.getParent();
         spool_file = new File(parent_path, agent.getName() + &quot;_&quot; + file_name);
         client_config.commandSpoolFileName = spool_file.getPath();
      }

      return client_config;
   }

   private ServerConfiguration prepareConfigurationPreferences() throws Exception {
      Preferences preferences_node = this.getPreferencesNode();
      ServerConfiguration config = new ServerConfiguration(preferences_node);
      if(config.getServerConfigurationVersion() == 0) {
         config = this.loadConfigurationFile();
      } else {
         LOG.debug(&quot;ServerCommunicationsService.preferences-already-exist&quot;, new Object[]{config.getPreferences()});
      }

      Properties overrides = this.getConfigurationOverrides();
      String bindAddress;
      if(overrides != null) {
         Iterator e = overrides.entrySet().iterator();

         while(e.hasNext()) {
            Entry scConfig = (Entry)e.next();
            bindAddress = scConfig.getKey().toString();
            String bindPort = scConfig.getValue().toString();
            bindPort = StringPropertyReplacer.replaceProperties(bindPort);
            preferences_node.put(bindAddress, bindPort);
            LOG.debug(&quot;ServerCommunicationsService.config-preference-override&quot;, new Object[]{bindAddress, bindPort});
         }
      }

      try {
         Preferences e1 = config.getPreferences();
         Server scConfig2 = LookupUtil.getServerManager().getServer();
         bindAddress = e1.get(&quot;rhq.communications.connector.bind-address&quot;, &quot;&quot;);
         int bindPort1 = e1.getInt(&quot;rhq.communications.connector.bind-port&quot;, -1);
         if(&quot;&quot;.equals(bindAddress)) {
            bindAddress = scConfig2.getAddress();
            preferences_node.put(&quot;rhq.communications.connector.bind-address&quot;, bindAddress);
         }

         if(-1 == bindPort1) {
            String transport = config.getPreferences().get(&quot;rhq.communications.connector.transport&quot;, &quot;socket&quot;);
            bindPort1 = SecurityUtil.isTransportSecure(transport)?scConfig2.getSecurePort():scConfig2.getPort();
            preferences_node.put(&quot;rhq.communications.connector.bind-port&quot;, String.valueOf(bindPort1));
         }
      } catch (Exception var9) {
         LOG.error(&quot;Unable to set explicit connector address/port, using defaults: &quot;, new Object[]{var9});
         ServiceContainerConfiguration scConfig1 = new ServiceContainerConfiguration(config.getPreferences());
         preferences_node.put(&quot;rhq.communications.connector.bind-address&quot;, scConfig1.getConnectorBindAddress());
         preferences_node.put(&quot;rhq.communications.connector.bind-port&quot;, String.valueOf(scConfig1.getConnectorBindPort()));
      }

      ServerConfigurationUpgrade.upgradeToLatest(config.getPreferences());
      LOG.debug(&quot;ServerCommunicationsService.config-preferences&quot;, new Object[]{config});
      return config;
   }

   private ServerConfiguration loadConfigurationFile() throws Exception {
      String file_name = this.getConfigurationFile();
      String preferences_node_name = this.getPreferencesNodeName();
      Object config_file_input_stream = null;
      LOG.debug(&quot;ServerCommunicationsService.pref-node-name&quot;, new Object[]{preferences_node_name});
      LOG.debug(&quot;ServerCommunicationsService.loading-config-file&quot;, new Object[]{file_name});

      try {
         File preferences_node = new File(file_name);
         if(preferences_node.exists()) {
            config_file_input_stream = new FileInputStream(preferences_node);
         }
      } catch (Exception var10) {
         ;
      }

      if(config_file_input_stream == null) {
         try {
            URL preferences_node1 = new URL(file_name);
            config_file_input_stream = preferences_node1.openStream();
         } catch (Exception var9) {
            ;
         }
      }

      if(config_file_input_stream == null) {
         config_file_input_stream = Thread.currentThread().getContextClassLoader().getResourceAsStream(file_name);
      }

      if(config_file_input_stream == null) {
         throw new IOException(LOG.getMsgString(&quot;ServerCommunicationsService.cannot-find-config-file&quot;, new Object[]{file_name}));
      } else {
         Preferences preferences_node2 = this.getPreferencesNode();
         ByteArrayOutputStream backup = new ByteArrayOutputStream();
         preferences_node2.exportSubtree(backup);
         preferences_node2.clear();

         try {
            Preferences.importPreferences((InputStream)config_file_input_stream);
            if((new ServerConfiguration(preferences_node2)).getServerConfigurationVersion() == 0) {
               throw new IllegalArgumentException(LOG.getMsgString(&quot;ServerCommunicationsService.bad-node-name-in-config-file&quot;, new Object[]{file_name, preferences_node_name}));
            }
         } catch (Exception var11) {
            try {
               Preferences.importPreferences(new ByteArrayInputStream(backup.toByteArray()));
            } catch (Exception var8) {
               ;
            }

            throw var11;
         }

         ServerConfiguration server_configuration = new ServerConfiguration(preferences_node2);
         LOG.debug(&quot;ServerCommunicationsService.loaded-config-file&quot;, new Object[]{file_name});
         return server_configuration;
      }
   }

   private Preferences getPreferencesNode() {
      Preferences topNode = Preferences.userRoot().node(&quot;rhq-server&quot;);
      Preferences preferencesNode = topNode.node(this.getPreferencesNodeName());
      return preferencesNode;
   }

   private File getServerPropertiesFile() {
      if(this.m_serverPropertiesFile == null) {
         ObjectName name = ObjectNameFactory.create(&quot;jboss.system:type=ServerConfig&quot;);
         Object mbean = MBeanServerInvocationHandler.newProxyInstance(this.m_mbs, name, ServerConfig.class, false);
         File homeDir = ((ServerConfig)mbean).getHomeDir();
         File binDir = new File(homeDir.getParentFile(), &quot;bin&quot;);
         this.m_serverPropertiesFile = new File(binDir, &quot;rhq-server.properties&quot;);
      }

      return this.m_serverPropertiesFile;
   }

   private void persistServerProperty(String name, String value) {
      String filePath = this.getServerPropertiesFile().getAbsolutePath();
      PropertiesFileUpdate updater = new PropertiesFileUpdate(filePath);

      try {
         updater.update(name, value);
      } catch (IOException var7) {
         String msgString = LOG.getMsgString(&quot;ServerCommunicationsService.server-property-save-failed&quot;, new Object[]{name, value, filePath});
         throw new RuntimeException(msgString, var7);
      }
   }

   private void setConcurrencyLimit(String limitName, Integer maxConcurrency, boolean persist) {
      if(maxConcurrency == null) {
         maxConcurrency = Integer.valueOf(-1);
      }

      if(persist) {
         this.persistServerProperty(limitName, String.valueOf(maxConcurrency));
      }

      ConcurrencyManager concurrencyManager = this.getServiceContainer().getConcurrencyManager();
      Map limits = concurrencyManager.getAllConfiguredNumberOfPermitsAllowed();
      limits.put(limitName, maxConcurrency);
      this.getServiceContainer().setConcurrencyManager(new ConcurrencyManager(limits));
      LOG.info(&quot;ServerCommunicationsService.new-concurrency-limit&quot;, new Object[]{limitName, maxConcurrency});
   }
}
</pre>
            </div> <!-- /container -->
        </div><!-- /row-->
    </div><!-- /container main-->


<div style="text-align: left; font-size: small; color: gray; font-style: italic;">Page generated: Sep 8, 2017 11:31:17 AM</div>
    <script src="resources/js/jquery-1.10.1.min.js"></script>
    <script src="resources/js/jquery-migrate-1.4.1.min.js"></script>
    <script src="resources/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="resources/libraries/jquery-ui/jquery.ui.widget.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.min.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.java-properties.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.java-manifest.js"></script>
    <script type="text/javascript" src="resources/libraries/sausage/jquery.sausage.min.js"></script>

    <script type="text/javascript">
        var script   = document.createElement("script");
        script.type  = "text/javascript";
            script.src   = "resources/js/navbar.js";
        document.body.appendChild(script);
    </script>

    <script type="text/javascript">
        $(window).on("hashchange", function () {
            window.scrollTo(window.scrollX, window.scrollY - 50);
        });
        function offsetAnchor() {
            if(location.hash.length !== 0) {
                window.scrollTo(window.scrollX, window.scrollY - 50);
            }
        }
        window.setTimeout(function() {
            offsetAnchor();
        }, 1);
        $(document).ready(function(){
            $("pre").snippet("java",{style:"ide-eclipse", showNum:true,boxFill:"#ffeeb9", box: "556" });

            $("<div id='556-inlines' class='inline-source-hint-group'/>").appendTo('ol.snippet-num li:nth-child(556)');


$("<a name='12389632' class='windup-file-location'></a><div class='inline-source-comment green tag-storage'><div class='inline-comment'><div class='inline-comment-heading'><strong class='notification warning'>File system - java.net.URL/URI</strong><a title='View Rule: local-storage-00002' href='windup_ruleproviders.html#local-storage-00002'><span class='glyphicon glyphicon-link rule-link floatRight'></span></a></div><div class='inline-comment-body'><p>Accessing a file on a local storage in a cloud environment is not safe because, inside a running container, an application can never assume that anything stored on disk will be permanently available because a restart (triggered by code deploy, config change, or the execution environment relocating the process to a different physical location) will usually wipe out all local (e.g., memory and filesystem) state.<\/p><p>There are different ways to improve the application based on what the file is used for:<\/p>\n<ul>\n  <li>logging: log to stdout [1] and use a centralized log collector to analyze logs [2]<\/li>\n  <li>caching: use a cache backing service accessed [3] via a URL or other locator/credentials stored in the config (see below)<\/li>\n  <li>config: store configurations in environment variables because they are easy to change between deploys without changing any code [4][5][6]<\/li>\n  <li>storing data: use a database backing service [3] in case of relational data or a persistent storage system [7][8][9][10]<\/li>\n  <li>temporary data: file system of a running container should be used to storing files only as a brief, single-transaction cache (e.g. downloading a large file, operating on it, and storing the results of the operation in the database)<\/li>\n<\/ul><p>References:<\/p>\n<ol>\n  <li><a href=\"https://12factor.net/logs\" target=\"_blank\">Twelve-factor app - Logs<\/a><\/li>\n  <li><a href=\"https://access.redhat.com/documentation/en/openshift-container-platform/3.4/paged/installation-and-configuration/chapter-28-aggregating-container-logs\" target=\"_blank\">OpenShift - Aggregating container logs<\/a><\/li>\n  <li><a href=\"https://12factor.net/backing-services\" target=\"_blank\">Twelve-factor app - Backing services<\/a><\/li>\n  <li><a href=\"https://12factor.net/config\" target=\"_blank\">Twelve-factor app - Config<\/a><\/li>\n  <li><a href=\"https://access.redhat.com/documentation/en/openshift-container-platform/3.4/paged/developer-guide/chapter-30-managing-environment-variables\" target=\"_blank\">OpenShift - Managing Environment Variables<\/a><\/li>\n  <li><a href=\"https://access.redhat.com/documentation/en/openshift-container-platform/3.4/paged/developer-guide/chapter-18-configmaps\" target=\"_blank\">OpenShift - ConfigMaps<\/a><\/li>\n  <li><a href=\"https://docs.openshift.com/container-platform/3.4/architecture/additional_concepts/storage.html\" target=\"_blank\">OpenShift - Persistent storage (Concepts)<\/a><\/li>\n  <li><a href=\"https://docs.openshift.com/container-platform/3.4/install_config/persistent_storage/index.html\" target=\"_blank\">OpenShift - Configure persistent storage<\/a><\/li>\n  <li><a href=\"https://blog.openshift.com/experimenting-with-persistent-volumes/\" target=\"_blank\">OpenShift - Blog post about persistent storage<\/a><\/li>\n  <li><a href=\"https://blog.openshift.com/openshift-applications-using-object-storage/\" target=\"_blank\">OpenShift - Object Storage<\/a><\/li>\n<\/ol></div></div></div>").appendTo('#556-inlines');


            $('code[class]').each(function(){
                 var codeSyntax = ($(this).attr('class'));
                 if(codeSyntax) {
                    $(this).parent().snippet(codeSyntax,{style:'ide-eclipse', menu:false, showNum:false});
                 }
            });
            $(window).sausage({ page: 'li.box' });
        });

        function qs(key) {
            key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
            var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
            return match && decodeURIComponent(match[1].replace(/\+/g, " "));
        }

        $(document).ready(function() {
            var defaultProjectID = 4062208;
            var selectedProject = qs("project");
            if (!selectedProject)
                selectedProject = defaultProjectID;

            $(".project-specific").each(function(index, element) {
                var currentProject = $(element).data("project-id");

                if (currentProject == selectedProject)
                    $(element).show();
                else
                    $(element).remove();
            });
            $("#main-navbar").show();
        });
    </script>

</body>
</html>
