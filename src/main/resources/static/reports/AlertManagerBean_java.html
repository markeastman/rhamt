<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Source Report for AlertManagerBean.java</title>
    <link href="resources/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="resources/css/windup.css" rel="stylesheet" media="screen"/>
    <link rel="stylesheet" type="text/css" href="resources/libraries/snippet/jquery.snippet.min.css" />
    <link rel="stylesheet" type="text/css" href="resources/css/windup-source.css" />
    <link rel="stylesheet" type="text/css" href="resources/libraries/sausage/sausage.css" />
    <link rel="shortcut icon" href="resources/img/rhamt-icon-128.png" type="image/x-icon"/>
</head>
<body role="document" class="source-report">

    <div class="navbar navbar-default navbar-fixed-top" id="main-navbar" style="display: none">
        <div class="wu-navbar-header navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <span class="wu-navbar-header">
              <strong class="wu-navbar-header">Red Hat Application Migration Toolkit</strong>
            </span>        </div>


                <div class="navbar-collapse collapse navbar-responsive-collapse project-specific" data-project-id="4062208">
    <ul class="nav navbar-nav">
            <li class="">
                <a href="../index.html"><i class="glyphicon glyphicon-home"></i> All Applications</a>
            </li>



                <li class="">
                    <a href="report_index_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-dashboard"></i>
                      Dashboard
                    </a>
                </li>


                <li class="">
                    <a href="migration_issues.1.html">
                        <i class="glyphicon glyphicon-warning-sign"></i>
                      Issues
                    </a>
                </li>


                <li class="">
                    <a href="ApplicationDetails_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-th-list"></i>
                      Application Details
                    </a>
                </li>


                <li class="">
                    <a href="dependency_report_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-compressed"></i>
                      Dependencies
                    </a>
                </li>


                <li class="">
                    <a href="remotereport_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon service-nav-logo"></i>
                      Remote Services
                    </a>
                </li>


                <li class="">
                    <a href="ejbreport_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon ejb-nav-logo"></i>
                      EJBs
                    </a>
                </li>


                <li class="">
                    <a href="jpa_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon jpa-nav-logo"></i>
                      JPA
                    </a>
                </li>


                <li class="">
                    <a href="server_resources_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon server-resource-nav-logo"></i>
                      Server Resources
                    </a>
                </li>


                <li class="">
                    <a href="hardcoded_ipsRHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-map-marker"></i>
                      Hard-coded IP Addresses
                    </a>
                </li>


                <li class="">
                    <a href="ignoredfiles_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-eye-close"></i>
                      Ignored Files
                    </a>
                </li>


                <li class="">
                    <a href="about_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-info-sign"></i>
                      About
                    </a>
                </li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
<li>
    <a href="#" class="feedback-nav-btn jiraFeedbackTrigger"><i class="glyphicon glyphicon-comment"></i> Send Feedback </a>
</li>


    <script type="text/javascript" src="https://issues.jboss.org/s/f215932e68571747ac58d0f5d554396f-T/en_US-r7luaf/6346/82/1.4.16/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-US&amp;collectorId=8b9e338b"></script>

    <script type="text/javascript">

    var FEEDBACK_JS_ADDED = false;
    var FEEDBACK_FORM_TRIGGER = null;

    function displayFeedbackForm() {
        FEEDBACK_FORM_TRIGGER();
    }

    window.ATL_JQ_PAGE_PROPS = {
        "triggerFunction": function(showCollectorDialog) {
            FEEDBACK_FORM_TRIGGER = showCollectorDialog;
        }
    };

    document.addEventListener("DOMContentLoaded", function(event) {
            jQuery(".jiraFeedbackTrigger").click(function(e) {
                e.preventDefault();
                displayFeedbackForm();
            });
    });
    </script>
    </ul>
                </div><!-- /.nav-collapse -->
    </div>


    <div class="container-fluid" role="main">
        <div class="row">
            <div class="page-header page-header-no-border">
                <h1>
                    <div class="main">Source Report</div>

                        <div class="path project-specific" data-project-id="4062208">
                            rhq-enterprise-server-ear-1.3.0.EmbJopr.1.3.0-4.ear/rhq-enterprise-server-ejb3.jar/org/rhq/enterprise/server/alert/AlertManagerBean.java
                        </div>
                </h1>
                <div class="desc">
                    This report displays what Red Hat Application Migration Toolkit found in individual files.
                    Each item is shown below the line it was found on,
                    and next to it, you may find a link to the rule which it was found by.
                </div>
            </div>
        </div>

        <div class="row">
            <div class="container-fluid theme-showcase" role="main">

                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Information</h3>
                    </div>
                    <div class="panel-body" style="overflow: auto;">

                        <!--<div style="height: 120pt; float:left;"></div> Keeps the minimal height. -->
                        <div class="points" style="text-align: center; color: #00254b; padding-bottom: 1ex;">
                            <div class="number">0</div>
                            <div>Story Points</div>
                        </div>

                        <div class="info" style="margin-left: 95pt;">

                            <h4>Technologies</h4>
                            <div class="technologies" style="overflow: auto"><!-- "auto" to contain all the tags. -->
                                    <span class="label label-info" title="INFORMATIONAL">Decompiled Java File</span>
                            </div>



                            <div style="clear: both;"/><!-- Snaps under the height keeper. Yes, the same effect could be achieved by a table. -->
                        </div><!-- .info -->
                    </div>
                </div>



                <pre id="source">
package org.rhq.enterprise.server.alert;

import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.ejb.TransactionAttribute;
import javax.ejb.TransactionAttributeType;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.jboss.annotation.IgnoreDependency;
import org.jboss.annotation.ejb.TransactionTimeout;
import org.quartz.SchedulerException;
import org.quartz.SimpleTrigger;
import org.rhq.core.domain.alert.Alert;
import org.rhq.core.domain.alert.AlertCondition;
import org.rhq.core.domain.alert.AlertConditionCategory;
import org.rhq.core.domain.alert.AlertConditionLog;
import org.rhq.core.domain.alert.AlertDefinition;
import org.rhq.core.domain.alert.AlertPriority;
import org.rhq.core.domain.alert.notification.AlertNotification;
import org.rhq.core.domain.alert.notification.AlertNotificationLog;
import org.rhq.core.domain.alert.notification.EmailNotification;
import org.rhq.core.domain.alert.notification.RoleNotification;
import org.rhq.core.domain.alert.notification.SnmpNotification;
import org.rhq.core.domain.alert.notification.SubjectNotification;
import org.rhq.core.domain.auth.Subject;
import org.rhq.core.domain.authz.Permission;
import org.rhq.core.domain.configuration.Configuration;
import org.rhq.core.domain.criteria.AlertCriteria;
import org.rhq.core.domain.measurement.MeasurementUnits;
import org.rhq.core.domain.measurement.util.MeasurementConverter;
import org.rhq.core.domain.operation.OperationDefinition;
import org.rhq.core.domain.resource.Resource;
import org.rhq.core.domain.util.CriteriaQueryGenerator;
import org.rhq.core.domain.util.PageControl;
import org.rhq.core.domain.util.PageList;
import org.rhq.core.domain.util.PageOrdering;
import org.rhq.core.domain.util.PersistenceUtility;
import org.rhq.core.domain.util.CriteriaQueryGenerator.AuthorizationTokenType;
import org.rhq.core.util.collection.ArrayUtils;
import org.rhq.enterprise.server.alert.AlertConditionLogManagerLocal;
import org.rhq.enterprise.server.alert.AlertDefinitionManagerLocal;
import org.rhq.enterprise.server.alert.AlertManagerLocal;
import org.rhq.enterprise.server.alert.AlertManagerRemote;
import org.rhq.enterprise.server.alert.SnmpTrapSender;
import org.rhq.enterprise.server.alert.i18n.AlertI18NFactory;
import org.rhq.enterprise.server.auth.SubjectManagerLocal;
import org.rhq.enterprise.server.authz.AuthorizationManagerLocal;
import org.rhq.enterprise.server.authz.PermissionException;
import org.rhq.enterprise.server.core.EmailManagerLocal;
import org.rhq.enterprise.server.measurement.instrumentation.MeasurementMonitor;
import org.rhq.enterprise.server.measurement.util.MeasurementFormatter;
import org.rhq.enterprise.server.operation.OperationManagerLocal;
import org.rhq.enterprise.server.resource.ResourceManagerLocal;
import org.rhq.enterprise.server.system.SystemManagerLocal;
import org.rhq.enterprise.server.util.LookupUtil;

@Stateless
public class AlertManagerBean implements AlertManagerLocal, AlertManagerRemote {
   @PersistenceContext(
      unitName = &quot;rhqpu&quot;
   )
   private EntityManager entityManager;
   private final Log log = LogFactory.getLog(AlertManagerBean.class);
   @EJB
   @IgnoreDependency
   private AlertConditionLogManagerLocal alertConditionLogManager;
   @EJB
   private AlertDefinitionManagerLocal alertDefinitionManager;
   @EJB
   private AuthorizationManagerLocal authorizationManager;
   @EJB
   @IgnoreDependency
   private ResourceManagerLocal resourceManager;
   @EJB
   private SubjectManagerLocal subjectManager;
   @EJB
   private SystemManagerLocal systemManager;
   @EJB
   @IgnoreDependency
   private OperationManagerLocal operationManager;
   @EJB
   private EmailManagerLocal emailManager;
   private static Date bootTime = null;
   private static String NEW_LINE = System.getProperty(&quot;line.separator&quot;);

   public Alert createAlert(Alert alert) {
      this.entityManager.persist(alert);
      return alert;
   }

   public Alert updateAlert(Alert alert) {
      return (Alert)this.entityManager.merge(alert);
   }

   private void deleteAlerts(Integer[] ids) {
      Integer[] arr$ = ids;
      int len$ = ids.length;

      for(int i$ = 0; i$ &lt; len$; ++i$) {
         Integer id = arr$[i$];
         Alert alert = (Alert)this.entityManager.find(Alert.class, id);
         if(alert != null) {
            AlertNotificationLog anl = alert.getAlertNotificationLog();
            this.entityManager.remove(anl);
            this.entityManager.remove(alert);
         }
      }

   }

   public void deleteAlerts(Subject user, int resourceId, Integer[] ids) {
      if(!this.authorizationManager.hasResourcePermission(user, Permission.MANAGE_ALERTS, resourceId)) {
         throw new PermissionException(&quot;User [&quot; + user.getName() + &quot;] does not have permissions to delete alerts &quot; + &quot;for resourceId=&quot; + resourceId);
      } else {
         this.deleteAlerts(ids);
      }
   }

   public void deleteAlertsForResourceGroup(Subject user, int resourceGroupId, Integer[] ids) {
      if(!this.authorizationManager.hasGroupPermission(user, Permission.MANAGE_ALERTS, resourceGroupId)) {
         throw new PermissionException(&quot;User [&quot; + user.getName() + &quot;] does not have permissions to delete alerts &quot; + &quot;for groupId=&quot; + resourceGroupId);
      } else {
         this.deleteAlerts(ids);
      }
   }

   @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
   @TransactionTimeout(1800)
   public int deleteAlerts(Subject user, int resourceId) {
      if(!this.authorizationManager.hasResourcePermission(user, Permission.MANAGE_ALERTS, resourceId)) {
         throw new PermissionException(&quot;User [&quot; + user.getName() + &quot;] does not have permissions to delete alerts &quot; + &quot;for resourceId=&quot; + resourceId);
      } else {
         long totalTime = 0L;
         long start = System.currentTimeMillis();
         Query query = this.entityManager.createNamedQuery(&quot;AlertConditionLog.deleteByResource&quot;);
         query.setParameter(&quot;resourceId&quot;, Integer.valueOf(resourceId));
         int deletedConditionLogs = query.executeUpdate();
         long end = System.currentTimeMillis();
         totalTime += end - start;
         this.log.debug(&quot;Performance: Deleted [&quot; + deletedConditionLogs + &quot;] AlertConditionLogs in [&quot; + (end - start) + &quot;]ms for resourceId[&quot; + resourceId + &quot;]&quot;);
         start = System.currentTimeMillis();
         query = this.entityManager.createNamedQuery(&quot;AlertNotificationLog.deleteByResource&quot;);
         query.setParameter(&quot;resourceId&quot;, Integer.valueOf(resourceId));
         int deletedNotifications = query.executeUpdate();
         end = System.currentTimeMillis();
         totalTime += end - start;
         this.log.debug(&quot;Performance: Deleted [&quot; + deletedNotifications + &quot;] AlertNotificationLogs in [&quot; + (end - start) + &quot;]ms for resourceId[&quot; + resourceId + &quot;]&quot;);
         start = System.currentTimeMillis();
         query = this.entityManager.createNamedQuery(&quot;Alert.deleteByResource&quot;);
         query.setParameter(&quot;resourceId&quot;, Integer.valueOf(resourceId));
         int deletedAlerts = query.executeUpdate();
         end = System.currentTimeMillis();
         totalTime += end - start;
         this.log.debug(&quot;Performance: Deleted [&quot; + deletedAlerts + &quot;] Alerts in [&quot; + (end - start) + &quot;]ms for resourceId[&quot; + resourceId + &quot;]&quot;);
         this.log.debug(&quot;Performance: Deleted [&quot; + (deletedConditionLogs + deletedNotifications + deletedAlerts) + &quot;] alert audit entities in [&quot; + totalTime + &quot;]ms for resourceId[&quot; + resourceId + &quot;]&quot;);
         return deletedAlerts;
      }
   }

   @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
   @TransactionTimeout(21600)
   public int deleteAlerts(long beginTime, long endTime) {
      long totalTime = 0L;
      long start = System.currentTimeMillis();
      Query query = this.entityManager.createNamedQuery(&quot;AlertConditionLog.deleteByAlertCTime&quot;);
      query.setParameter(&quot;begin&quot;, Long.valueOf(beginTime));
      query.setParameter(&quot;end&quot;, Long.valueOf(endTime));
      int conditionsDeleted = query.executeUpdate();
      long end = System.currentTimeMillis();
      this.log.debug(&quot;Deleted [&quot; + conditionsDeleted + &quot;] alert condition logs in [&quot; + (end - start) + &quot;]ms&quot;);
      totalTime += end - start;
      start = System.currentTimeMillis();
      query = this.entityManager.createNamedQuery(&quot;AlertNotificationLog.deleteByAlertCtime&quot;);
      query.setParameter(&quot;begin&quot;, Long.valueOf(beginTime));
      query.setParameter(&quot;end&quot;, Long.valueOf(endTime));
      int deletedNotifications = query.executeUpdate();
      end = System.currentTimeMillis();
      this.log.debug(&quot;Deleted [&quot; + deletedNotifications + &quot;] alert notifications in [&quot; + (end - start) + &quot;]ms&quot;);
      totalTime += end - start;
      start = System.currentTimeMillis();
      query = this.entityManager.createNamedQuery(&quot;Alert.deleteByCTime&quot;);
      query.setParameter(&quot;begin&quot;, Long.valueOf(beginTime));
      query.setParameter(&quot;end&quot;, Long.valueOf(endTime));
      int deletedAlerts = query.executeUpdate();
      end = System.currentTimeMillis();
      this.log.debug(&quot;Deleted [&quot; + deletedAlerts + &quot;] alerts in [&quot; + (end - start) + &quot;]ms&quot;);
      totalTime += end - start;
      MeasurementMonitor.getMBean().incrementPurgeTime(totalTime);
      MeasurementMonitor.getMBean().setPurgedAlerts((long)deletedAlerts);
      MeasurementMonitor.getMBean().setPurgedAlertConditions((long)conditionsDeleted);
      MeasurementMonitor.getMBean().setPurgedAlertNotifications((long)deletedNotifications);
      this.log.debug(&quot;Deleted [&quot; + (deletedAlerts + conditionsDeleted + deletedNotifications) + &quot;] &quot; + &quot;alert audit records in [&quot; + totalTime + &quot;]ms&quot;);
      return deletedAlerts;
   }

   public Alert getById(int alertId) {
      Alert alert = (Alert)this.entityManager.find(Alert.class, Integer.valueOf(alertId));
      if(alert == null) {
         return null;
      } else {
         this.fetchCollectionFields(alert);
         return alert;
      }
   }

   public int getAlertCountByMeasurementDefinitionId(Integer measurementDefinitionId, long begin, long end) {
      Query query = PersistenceUtility.createCountQuery(this.entityManager, &quot;Alert.findByMeasurementDefinitionId&quot;);
      query.setParameter(&quot;measurementDefinitionId&quot;, measurementDefinitionId);
      query.setParameter(&quot;begin&quot;, Long.valueOf(begin));
      query.setParameter(&quot;end&quot;, Long.valueOf(end));
      long count = ((Long)query.getSingleResult()).longValue();
      return (int)count;
   }

   public int getAlertCountByMeasurementDefinitionAndResources(int measurementDefinitionId, int[] resourceIds, long beginDate, long endDate) {
      Query query = PersistenceUtility.createCountQuery(this.entityManager, &quot;Alert.findByMeasDefIdAndResources&quot;);
      query.setParameter(&quot;measurementDefinitionId&quot;, Integer.valueOf(measurementDefinitionId));
      query.setParameter(&quot;startDate&quot;, Long.valueOf(beginDate));
      query.setParameter(&quot;endDate&quot;, Long.valueOf(endDate));
      query.setParameter(&quot;resourceIds&quot;, ArrayUtils.wrapInList(resourceIds));
      long count = ((Long)query.getSingleResult()).longValue();
      return (int)count;
   }

   public int getAlertCountByMeasurementDefinitionAndResourceGroup(int measurementDefinitionId, int groupId, long beginDate, long endDate) {
      Query query = PersistenceUtility.createCountQuery(this.entityManager, &quot;Alert.findByMeasDefIdAndResourceGroup&quot;);
      query.setParameter(&quot;measurementDefinitionId&quot;, Integer.valueOf(measurementDefinitionId));
      query.setParameter(&quot;startDate&quot;, Long.valueOf(beginDate));
      query.setParameter(&quot;endDate&quot;, Long.valueOf(endDate));
      query.setParameter(&quot;groupId&quot;, Integer.valueOf(groupId));
      long count = ((Long)query.getSingleResult()).longValue();
      return (int)count;
   }

   public int getAlertCountByMeasurementDefinitionAndAutoGroup(int measurementDefinitionId, int resourceParentId, int resourceTypeId, long beginDate, long endDate) {
      Query query = PersistenceUtility.createCountQuery(this.entityManager, &quot;Alert.findByMeasDefIdAndAutoGroup&quot;);
      query.setParameter(&quot;measurementDefinitionId&quot;, Integer.valueOf(measurementDefinitionId));
      query.setParameter(&quot;startDate&quot;, Long.valueOf(beginDate));
      query.setParameter(&quot;endDate&quot;, Long.valueOf(endDate));
      query.setParameter(&quot;parentId&quot;, Integer.valueOf(resourceParentId));
      query.setParameter(&quot;typeId&quot;, Integer.valueOf(resourceTypeId));
      long count = ((Long)query.getSingleResult()).longValue();
      return (int)count;
   }

   public int getAlertCountByMeasurementDefinitionAndResource(int measurementDefinitionId, int resourceId, long beginDate, long endDate) {
      Query query = PersistenceUtility.createCountQuery(this.entityManager, &quot;Alert.findByMeasDefIdAndResource&quot;);
      query.setParameter(&quot;measurementDefinitionId&quot;, Integer.valueOf(measurementDefinitionId));
      query.setParameter(&quot;startDate&quot;, Long.valueOf(beginDate));
      query.setParameter(&quot;endDate&quot;, Long.valueOf(endDate));
      query.setParameter(&quot;resourceId&quot;, Integer.valueOf(resourceId));
      long count = ((Long)query.getSingleResult()).longValue();
      return (int)count;
   }

   public Map getAlertCountForSchedules(long begin, long end, List scheduleIds) {
      if(scheduleIds != null &amp;&amp; scheduleIds.size() != 0 &amp;&amp; end &gt;= begin) {
         boolean BATCH_SIZE = true;
         int numSched = scheduleIds.size();
         int rounds = numSched / 1000 + 1;
         HashMap resMap = new HashMap();

         int scheduleId;
         for(int i$ = 0; i$ &lt; rounds; ++i$) {
            scheduleId = i$ * 1000;
            int toIndex = scheduleId + 1000;
            if(toIndex &gt; numSched) {
               toIndex = numSched;
            }

            List scheds = scheduleIds.subList(scheduleId, toIndex);
            if(scheduleId != toIndex) {
               Query q = this.entityManager.createNamedQuery(&quot;Alert.QUERY_GET_ALERT_COUNT_FOR_SCHEDULES&quot;);
               q.setParameter(&quot;startDate&quot;, Long.valueOf(begin));
               q.setParameter(&quot;endDate&quot;, Long.valueOf(end));
               q.setParameter(&quot;schedIds&quot;, scheds);
               List ret = q.getResultList();
               if(ret.size() &gt; 0) {
                  Iterator i$1 = ret.iterator();

                  while(i$1.hasNext()) {
                     Object[] obj = (Object[])i$1.next();
                     Integer scheduleId1 = (Integer)obj[0];
                     Long tmp = (Long)obj[1];
                     int alertCount = tmp.intValue();
                     resMap.put(scheduleId1, Integer.valueOf(alertCount));
                  }
               }
            }
         }

         Iterator var21 = scheduleIds.iterator();

         while(var21.hasNext()) {
            scheduleId = ((Integer)var21.next()).intValue();
            if(!resMap.containsKey(Integer.valueOf(scheduleId))) {
               resMap.put(Integer.valueOf(scheduleId), Integer.valueOf(0));
            }
         }

         return resMap;
      } else {
         return new HashMap();
      }
   }

   public PageList findAlerts(Subject subject, Integer[] resourceIds, AlertPriority priority, long timeRange, PageControl pageControl) {
      pageControl.initDefaultOrderingField(&quot;a.ctime&quot;, PageOrdering.DESC);
      if(resourceIds != null &amp;&amp; resourceIds.length == 0) {
         return new PageList(pageControl);
      } else {
         String queryStr;
         if(this.authorizationManager.isInventoryManager(subject)) {
            queryStr = resourceIds == null?&quot;Alert.DashboardAll_admin&quot;:&quot;Alert.DashboardByResourceIds_admin&quot;;
         } else {
            queryStr = resourceIds == null?&quot;Alert.DashboardAll&quot;:&quot;Alert.DashboardByResourceIds&quot;;
         }

         Query query = PersistenceUtility.createQueryWithOrderBy(this.entityManager, queryStr, pageControl);
         Query queryCount = PersistenceUtility.createCountQuery(this.entityManager, queryStr);
         if(!this.authorizationManager.isInventoryManager(subject)) {
            query.setParameter(&quot;subjectId&quot;, Integer.valueOf(subject.getId()));
            queryCount.setParameter(&quot;subjectId&quot;, Integer.valueOf(subject.getId()));
         }

         if(resourceIds != null) {
            List startTime = Arrays.asList(resourceIds);
            queryCount.setParameter(&quot;resourceIds&quot;, startTime);
            query.setParameter(&quot;resourceIds&quot;, startTime);
         }

         long startTime1 = System.currentTimeMillis() - timeRange;
         queryCount.setParameter(&quot;startDate&quot;, Long.valueOf(startTime1));
         queryCount.setParameter(&quot;priority&quot;, priority);
         query.setParameter(&quot;startDate&quot;, Long.valueOf(startTime1));
         query.setParameter(&quot;priority&quot;, priority);
         long totalCount = ((Long)queryCount.getSingleResult()).longValue();
         List alerts = query.getResultList();
         this.fetchCollectionFields(alerts);
         return new PageList(alerts, (int)totalCount, pageControl);
      }
   }

   public PageList findAlerts(int resourceId, Integer alertDefinitionId, AlertPriority priority, Long beginDate, Long endDate, PageControl pageControl) {
      pageControl.initDefaultOrderingField(&quot;a.ctime&quot;, PageOrdering.DESC);
      String queryStr = &quot;Alert.findByResourceDated&quot;;
      Query queryCount = PersistenceUtility.createCountQuery(this.entityManager, queryStr);
      Query query = PersistenceUtility.createQueryWithOrderBy(this.entityManager, queryStr, pageControl);
      queryCount.setParameter(&quot;id&quot;, Integer.valueOf(resourceId));
      query.setParameter(&quot;id&quot;, Integer.valueOf(resourceId));
      queryCount.setParameter(&quot;startDate&quot;, beginDate);
      query.setParameter(&quot;startDate&quot;, beginDate);
      queryCount.setParameter(&quot;endDate&quot;, endDate);
      query.setParameter(&quot;endDate&quot;, endDate);
      queryCount.setParameter(&quot;alertDefinitionId&quot;, alertDefinitionId);
      query.setParameter(&quot;alertDefinitionId&quot;, alertDefinitionId);
      queryCount.setParameter(&quot;priority&quot;, priority);
      query.setParameter(&quot;priority&quot;, priority);
      long totalCount = ((Long)queryCount.getSingleResult()).longValue();
      List alerts = query.getResultList();
      this.fetchCollectionFields(alerts);
      return new PageList(alerts, (int)totalCount, pageControl);
   }

   private void fetchCollectionFields(Alert alert) {
      alert.getConditionLogs().size();
      Iterator i$ = alert.getConditionLogs().iterator();

      while(i$.hasNext()) {
         AlertConditionLog log = (AlertConditionLog)i$.next();
         if(log.getCondition() != null &amp;&amp; log.getCondition().getMeasurementDefinition() != null) {
            log.getCondition().getMeasurementDefinition().getId();
         }
      }

   }

   private void fetchCollectionFields(List alerts) {
      Iterator i$ = alerts.iterator();

      while(i$.hasNext()) {
         Alert alert = (Alert)i$.next();
         this.fetchCollectionFields(alert);
      }

   }

   public void fireAlert(int alertDefinitionId) {
      this.log.debug(&quot;Firing an alert for alertDefinition with id=&quot; + alertDefinitionId + &quot;...&quot;);
      Subject overlord = this.subjectManager.getOverlord();
      AlertDefinition alertDefinition = this.alertDefinitionManager.getAlertDefinitionById(overlord, alertDefinitionId);
      Alert newAlert = new Alert(alertDefinition, System.currentTimeMillis());
      this.createAlert(newAlert);
      this.log.debug(&quot;New alert identifier=&quot; + newAlert.getId());
      AlertNotificationLog alertNotifLog = new AlertNotificationLog(newAlert);
      this.entityManager.persist(alertNotifLog);
      List unmatchedConditionLogs = this.alertConditionLogManager.getUnmatchedLogsByAlertDefinitionId(alertDefinitionId);
      Iterator i$ = unmatchedConditionLogs.iterator();

      while(i$.hasNext()) {
         AlertConditionLog unmatchedLog = (AlertConditionLog)i$.next();
         this.log.debug(&quot;Matched alert condition log for alertId=&quot; + newAlert.getId() + &quot;: &quot; + unmatchedLog);
         newAlert.addConditionLog(unmatchedLog);
      }

      this.processRecovery(alertDefinition);
      this.sendAlertNotifications(newAlert);
      this.triggerOperation(alertDefinition);
   }

   @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
   public void triggerOperation(AlertDefinition alertDefinition) {
      OperationDefinition operationDefinition = alertDefinition.getOperationDefinition();
      if(operationDefinition != null) {
         Subject overlord = this.subjectManager.getOverlord();

         try {
            this.operationManager.scheduleResourceOperation(overlord, alertDefinition.getResource().getId(), operationDefinition.getName(), (Configuration)null, new SimpleTrigger(&quot;alerting&quot;, &quot;alerting&quot;, new Date()), &quot;Triggered when &quot; + alertDefinition.toSimpleString() + &quot; fired an alert off&quot;);
         } catch (SchedulerException var5) {
            this.log.error(alertDefinition.toSimpleString() + &quot; could not successfully schedule &quot; + &quot;its operation &quot; + operationDefinition.getName());
         }

      }
   }

   @TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
   public void sendAlertNotifications(Alert alert) {
      try {
         this.log.debug(&quot;Sending alert notifications for &quot; + alert.toSimpleString() + &quot;...&quot;);
         Set e = alert.getAlertDefinition().getAlertNotifications();
         LinkedHashSet emailAddresses = new LinkedHashSet();
         Iterator i$ = e.iterator();

         while(true) {
            while(i$.hasNext()) {
               AlertNotification alertNotification = (AlertNotification)i$.next();
               if(alertNotification instanceof RoleNotification) {
                  RoleNotification snmpNotification3 = (RoleNotification)alertNotification;
                  Set emailAddress2 = snmpNotification3.getRole().getSubjects();
                  Iterator i$1 = emailAddress2.iterator();

                  while(i$1.hasNext()) {
                     Subject subject = (Subject)i$1.next();
                     if(!subject.getFsystem()) {
                        String emailAddress1 = subject.getEmailAddress();
                        this.processEmailAddress(alert, emailAddress1, emailAddresses);
                     }
                  }
               } else {
                  String emailAddress;
                  if(alertNotification instanceof SubjectNotification) {
                     SubjectNotification snmpNotification = (SubjectNotification)alertNotification;
                     emailAddress = snmpNotification.getSubject().getEmailAddress();
                     this.processEmailAddress(alert, emailAddress, emailAddresses);
                  } else if(alertNotification instanceof EmailNotification) {
                     EmailNotification snmpNotification1 = (EmailNotification)alertNotification;
                     emailAddress = snmpNotification1.getEmailAddress();
                     this.processEmailAddress(alert, emailAddress, emailAddresses);
                  } else if(alertNotification instanceof SnmpNotification) {
                     SnmpNotification snmpNotification2 = (SnmpNotification)alertNotification;
                     this.sendAlertSnmpTrap(alert, snmpNotification2);
                  }
               }
            }

            this.sendAlertNotificationEmails(alert, emailAddresses);
            break;
         }
      } catch (Exception var11) {
         this.log.error(&quot;Failed to send all notifications for &quot; + alert.toSimpleString(), var11);
      }

   }

   private void processEmailAddress(Alert alert, String emailAddress, Set emailAddresses) {
      if(emailAddress != null) {
         emailAddress = emailAddress.toLowerCase();
         if(!emailAddresses.contains(emailAddress)) {
            emailAddresses.add(emailAddress);
         }

      }
   }

   private void sendAlertNotificationEmails(Alert alert, Set emailAddresses) {
      this.log.debug(&quot;Sending alert notifications for &quot; + alert.toSimpleString() + &quot;...&quot;);
      AlertDefinition alertDefinition = alert.getAlertDefinition();
      Map alertMessage = this.emailManager.getAlertEmailMessage(this.prettyPrintResourceHierarchy(alertDefinition.getResource()), alertDefinition.getResource().getName(), alertDefinition.getName(), alertDefinition.getPriority().toString(), (new Date(alert.getCtime())).toString(), this.prettyPrintAlertConditions(alert.getConditionLogs()), this.prettyPrintAlertURL(alert));
      String messageSubject = (String)alertMessage.keySet().iterator().next();
      String messageBody = (String)alertMessage.values().iterator().next();

      try {
         this.emailManager.sendEmail(emailAddresses, messageSubject, messageBody);
         this.log.debug(&quot;All notifications for &quot; + alert.toSimpleString() + &quot; succeeded&quot;);
      } catch (Throwable var8) {
         this.log.error(&quot;One or more notifications for &quot; + alert.toSimpleString() + &quot; failed: &quot; + var8.getMessage());
      }

   }

   private String prettyPrintResourceHierarchy(Resource resource) {
      StringBuilder builder = new StringBuilder();
      List lineage = this.resourceManager.getResourceLineage(resource.getId());
      int depth = 0;

      for(Iterator i$ = lineage.iterator(); i$.hasNext(); ++depth) {
         Resource res = (Resource)i$.next();
         if(depth == 0) {
            builder.append(&quot; - &quot;);
         } else {
            builder.append(NEW_LINE);

            int i;
            for(i = 0; i &lt; depth; ++i) {
               builder.append(&quot;   &quot;);
            }

            builder.append(&quot;|&quot;);
            builder.append(NEW_LINE);

            for(i = 0; i &lt; depth; ++i) {
               builder.append(&quot;   &quot;);
            }

            builder.append(&quot;+- &quot;);
         }

         builder.append(res.getName());
      }

      return builder.toString();
   }

   private String prettyPrintAlertConditions(Set conditionLogs) {
      StringBuilder builder = new StringBuilder();
      int conditionCounter = 1;

      for(Iterator i$ = conditionLogs.iterator(); i$.hasNext(); ++conditionCounter) {
         AlertConditionLog aLog = (AlertConditionLog)i$.next();
         String formattedValue = null;

         try {
            formattedValue = MeasurementConverter.format(Double.valueOf(aLog.getValue()), aLog.getCondition().getMeasurementDefinition().getUnits(), true);
         } catch (Exception var8) {
            formattedValue = aLog.getValue();
         }

         builder.append(NEW_LINE);
         builder.append(AlertI18NFactory.getMessage(&quot;alert.email.condition.log.format&quot;, new Object[]{Integer.valueOf(conditionCounter), this.prettyPrintAlertCondition(aLog.getCondition()), (new SimpleDateFormat(&quot;yyyy/MM/dd HH:mm:ss z&quot;)).format(new Date(aLog.getCtime())), formattedValue}));
      }

      return builder.toString();
   }

   private String prettyPrintAlertCondition(AlertCondition condition) {
      StringBuilder builder = new StringBuilder();
      AlertConditionCategory category = condition.getCategory();
      Integer schedule;
      if(category == AlertConditionCategory.CONTROL) {
         try {
            schedule = Integer.valueOf(condition.getAlertDefinition().getResource().getResourceType().getId());
            String units = condition.getName();
            OperationDefinition value = this.operationManager.getOperationDefinitionByResourceTypeAndName(schedule.intValue(), units, false);
            builder.append(value.getDisplayName()).append(' ');
         } catch (Exception var9) {
            builder.append(condition.getName()).append(' ');
         }
      } else {
         builder.append(condition.getName()).append(' ');
      }

      if(category == AlertConditionCategory.CONTROL) {
         builder.append(condition.getOption());
      } else if(category != AlertConditionCategory.THRESHOLD &amp;&amp; category != AlertConditionCategory.BASELINE) {
         if(category != AlertConditionCategory.RESOURCE_CONFIG &amp;&amp; category != AlertConditionCategory.CHANGE &amp;&amp; category != AlertConditionCategory.TRAIT) {
            if(category == AlertConditionCategory.EVENT) {
               if(condition.getOption() != null &amp;&amp; condition.getOption().length() &gt; 0) {
                  builder.append(AlertI18NFactory.getMessage(&quot;alert.config.props.CB.EventSeverity.RegexMatch&quot;, new Object[]{condition.getName(), condition.getOption()}));
               } else {
                  builder.append(AlertI18NFactory.getMessage(&quot;alert.config.props.CB.EventSeverity&quot;, new Object[]{condition.getName()}));
               }
            } else if(category == AlertConditionCategory.AVAILABILITY) {
               builder.append(AlertI18NFactory.getMessage(&quot;alert.config.props.CB.Availability&quot;, new Object[]{condition.getOption()}));
            }
         } else {
            builder.append(AlertI18NFactory.getMessage(&quot;alert.current.list.ValueChanged&quot;, new Object[0]));
         }
      } else {
         builder.append(condition.getComparator());
         builder.append(' ');
         schedule = null;
         double value1 = condition.getThreshold().doubleValue();
         MeasurementUnits units1;
         if(category == AlertConditionCategory.THRESHOLD) {
            units1 = condition.getMeasurementDefinition().getUnits();
         } else {
            units1 = MeasurementUnits.PERCENTAGE;
         }

         String formatted = MeasurementConverter.format(Double.valueOf(value1), units1, true);
         builder.append(formatted);
         if(category == AlertConditionCategory.BASELINE) {
            builder.append(&quot; of &quot;);
            builder.append(MeasurementFormatter.getBaselineText(condition.getOption(), schedule));
         }
      }

      return builder.toString();
   }

   private String prettyPrintAlertURL(Alert alert) {
      StringBuilder builder = new StringBuilder();
      String baseUrl = this.systemManager.getSystemConfiguration().getProperty(&quot;CAM_BASE_URL&quot;);
      builder.append(baseUrl);
      if(!baseUrl.endsWith(&quot;/&quot;)) {
         builder.append(&quot;/&quot;);
      }

      builder.append(&quot;alerts/Alerts.do?mode=viewAlert&quot;);
      builder.append(&quot;&amp;id=&quot; + alert.getAlertDefinition().getResource().getId());
      builder.append(&quot;&amp;a=&quot; + alert.getId());
      return builder.toString();
   }

   private void sendAlertSnmpTrap(Alert alert, SnmpNotification snmpNotification) {
      SnmpTrapSender snmpTrapSender = new SnmpTrapSender();
      this.log.debug(&quot;Sending SNMP trap with OID &quot; + snmpNotification.getOid() + &quot; to SNMP engine &quot; + snmpNotification.getHost() + &quot;:&quot; + snmpNotification.getPort() + &quot;...&quot;);
      List lineage = this.resourceManager.getResourceLineage(alert.getAlertDefinition().getResource().getId());
      String platformName = ((Resource)lineage.get(0)).getName();
      String conditions = this.prettyPrintAlertConditions(alert.getConditionLogs());
      String alertUrl = this.prettyPrintAlertURL(alert);

      String result;
      try {
         if(bootTime == null) {
            bootTime = LookupUtil.getCoreServer().getBootTime();
         }

         result = snmpTrapSender.sendSnmpTrap(alert, snmpNotification, platformName, conditions, bootTime, alertUrl);
      } catch (Throwable var10) {
         result = &quot;failed - cause: &quot; + var10;
      }

      this.log.debug(&quot;Result of sending SNMP trap: &quot; + result);
   }

   private void processRecovery(AlertDefinition firedDefinition) {
      Subject overlord = this.subjectManager.getOverlord();
      Integer recoveryDefinitionId = firedDefinition.getRecoveryId();
      if(recoveryDefinitionId.intValue() != 0) {
         this.log.debug(&quot;Processing recovery rules...&quot;);
         this.log.debug(&quot;Found recoveryDefinitionId &quot; + recoveryDefinitionId);
         AlertDefinition toBeRecoveredDefinition = this.alertDefinitionManager.getAlertDefinitionById(overlord, recoveryDefinitionId.intValue());
         boolean wasEnabled = toBeRecoveredDefinition.getEnabled();
         this.log.debug(firedDefinition + (wasEnabled?&quot;does not need to recover &quot;:&quot;needs to recover &quot;) + toBeRecoveredDefinition + (wasEnabled?&quot;, it was already enabled &quot;:&quot;, it was currently disabled &quot;));
         if(!wasEnabled) {
            this.alertDefinitionManager.enableAlertDefinitions(overlord, new Integer[]{recoveryDefinitionId});
         }
      } else if(firedDefinition.getWillRecover()) {
         this.log.debug(&quot;Disabling &quot; + firedDefinition + &quot; until recovered manually or by recovery definition&quot;);
         this.alertDefinitionManager.disableAlertDefinitions(overlord, new Integer[]{Integer.valueOf(firedDefinition.getId())});
      }

   }

   public PageList findAlertsByCriteria(Subject subject, AlertCriteria criteria) {
      CriteriaQueryGenerator generator = new CriteriaQueryGenerator(criteria);
      if(!this.authorizationManager.isInventoryManager(subject)) {
         generator.setAuthorizationResourceFragment(AuthorizationTokenType.RESOURCE, &quot;alertDefinition.resource&quot;, subject.getId());
      }

      Query query = generator.getQuery(this.entityManager);
      Query countQuery = generator.getCountQuery(this.entityManager);
      long count = ((Long)countQuery.getSingleResult()).longValue();
      List alerts = query.getResultList();
      this.fetchCollectionFields(alerts);
      return new PageList(alerts, (int)count, criteria.getPageControl());
   }
}
</pre>
            </div> <!-- /container -->
        </div><!-- /row-->
    </div><!-- /container main-->


<div style="text-align: left; font-size: small; color: gray; font-style: italic;">Page generated: Sep 8, 2017 11:31:19 AM</div>
    <script src="resources/js/jquery-1.10.1.min.js"></script>
    <script src="resources/js/jquery-migrate-1.4.1.min.js"></script>
    <script src="resources/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="resources/libraries/jquery-ui/jquery.ui.widget.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.min.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.java-properties.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.java-manifest.js"></script>
    <script type="text/javascript" src="resources/libraries/sausage/jquery.sausage.min.js"></script>

    <script type="text/javascript">
        var script   = document.createElement("script");
        script.type  = "text/javascript";
            script.src   = "resources/js/navbar.js";
        document.body.appendChild(script);
    </script>

    <script type="text/javascript">
        $(window).on("hashchange", function () {
            window.scrollTo(window.scrollX, window.scrollY - 50);
        });
        function offsetAnchor() {
            if(location.hash.length !== 0) {
                window.scrollTo(window.scrollX, window.scrollY - 50);
            }
        }
        window.setTimeout(function() {
            offsetAnchor();
        }, 1);
        $(document).ready(function(){
            $("pre").snippet("java",{style:"ide-eclipse", showNum:true,boxFill:"#ffeeb9", box: "" });




            $('code[class]').each(function(){
                 var codeSyntax = ($(this).attr('class'));
                 if(codeSyntax) {
                    $(this).parent().snippet(codeSyntax,{style:'ide-eclipse', menu:false, showNum:false});
                 }
            });
            $(window).sausage({ page: 'li.box' });
        });

        function qs(key) {
            key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
            var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
            return match && decodeURIComponent(match[1].replace(/\+/g, " "));
        }

        $(document).ready(function() {
            var defaultProjectID = 4062208;
            var selectedProject = qs("project");
            if (!selectedProject)
                selectedProject = defaultProjectID;

            $(".project-specific").each(function(index, element) {
                var currentProject = $(element).data("project-id");

                if (currentProject == selectedProject)
                    $(element).show();
                else
                    $(element).remove();
            });
            $("#main-navbar").show();
        });
    </script>

</body>
</html>
