<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Source Report for FailoverListManagerBean.java</title>
    <link href="resources/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="resources/css/windup.css" rel="stylesheet" media="screen"/>
    <link rel="stylesheet" type="text/css" href="resources/libraries/snippet/jquery.snippet.min.css" />
    <link rel="stylesheet" type="text/css" href="resources/css/windup-source.css" />
    <link rel="stylesheet" type="text/css" href="resources/libraries/sausage/sausage.css" />
    <link rel="shortcut icon" href="resources/img/rhamt-icon-128.png" type="image/x-icon"/>
</head>
<body role="document" class="source-report">

    <div class="navbar navbar-default navbar-fixed-top" id="main-navbar" style="display: none">
        <div class="wu-navbar-header navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <span class="wu-navbar-header">
              <strong class="wu-navbar-header">Red Hat Application Migration Toolkit</strong>
            </span>        </div>


                <div class="navbar-collapse collapse navbar-responsive-collapse project-specific" data-project-id="4062208">
    <ul class="nav navbar-nav">
            <li class="">
                <a href="../index.html"><i class="glyphicon glyphicon-home"></i> All Applications</a>
            </li>



                <li class="">
                    <a href="report_index_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-dashboard"></i>
                      Dashboard
                    </a>
                </li>


                <li class="">
                    <a href="migration_issues.1.html">
                        <i class="glyphicon glyphicon-warning-sign"></i>
                      Issues
                    </a>
                </li>


                <li class="">
                    <a href="ApplicationDetails_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-th-list"></i>
                      Application Details
                    </a>
                </li>


                <li class="">
                    <a href="dependency_report_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-compressed"></i>
                      Dependencies
                    </a>
                </li>


                <li class="">
                    <a href="remotereport_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon service-nav-logo"></i>
                      Remote Services
                    </a>
                </li>


                <li class="">
                    <a href="ejbreport_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon ejb-nav-logo"></i>
                      EJBs
                    </a>
                </li>


                <li class="">
                    <a href="jpa_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon jpa-nav-logo"></i>
                      JPA
                    </a>
                </li>


                <li class="">
                    <a href="server_resources_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon server-resource-nav-logo"></i>
                      Server Resources
                    </a>
                </li>


                <li class="">
                    <a href="hardcoded_ipsRHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-map-marker"></i>
                      Hard-coded IP Addresses
                    </a>
                </li>


                <li class="">
                    <a href="ignoredfiles_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-eye-close"></i>
                      Ignored Files
                    </a>
                </li>


                <li class="">
                    <a href="about_RHQ_Enterprise_Server_EAR.html">
                        <i class="glyphicon glyphicon-info-sign"></i>
                      About
                    </a>
                </li>
    </ul>
    <ul class="nav navbar-nav navbar-right">
<li>
    <a href="#" class="feedback-nav-btn jiraFeedbackTrigger"><i class="glyphicon glyphicon-comment"></i> Send Feedback </a>
</li>


    <script type="text/javascript" src="https://issues.jboss.org/s/f215932e68571747ac58d0f5d554396f-T/en_US-r7luaf/6346/82/1.4.16/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector.js?locale=en-US&amp;collectorId=8b9e338b"></script>

    <script type="text/javascript">

    var FEEDBACK_JS_ADDED = false;
    var FEEDBACK_FORM_TRIGGER = null;

    function displayFeedbackForm() {
        FEEDBACK_FORM_TRIGGER();
    }

    window.ATL_JQ_PAGE_PROPS = {
        "triggerFunction": function(showCollectorDialog) {
            FEEDBACK_FORM_TRIGGER = showCollectorDialog;
        }
    };

    document.addEventListener("DOMContentLoaded", function(event) {
            jQuery(".jiraFeedbackTrigger").click(function(e) {
                e.preventDefault();
                displayFeedbackForm();
            });
    });
    </script>
    </ul>
                </div><!-- /.nav-collapse -->
    </div>


    <div class="container-fluid" role="main">
        <div class="row">
            <div class="page-header page-header-no-border">
                <h1>
                    <div class="main">Source Report</div>

                        <div class="path project-specific" data-project-id="4062208">
                            rhq-enterprise-server-ear-1.3.0.EmbJopr.1.3.0-4.ear/rhq-enterprise-server-ejb3.jar/org/rhq/enterprise/server/cloud/FailoverListManagerBean.java
                        </div>
                </h1>
                <div class="desc">
                    This report displays what Red Hat Application Migration Toolkit found in individual files.
                    Each item is shown below the line it was found on,
                    and next to it, you may find a link to the rule which it was found by.
                </div>
            </div>
        </div>

        <div class="row">
            <div class="container-fluid theme-showcase" role="main">

                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h3 class="panel-title">Information</h3>
                    </div>
                    <div class="panel-body" style="overflow: auto;">

                        <!--<div style="height: 120pt; float:left;"></div> Keeps the minimal height. -->
                        <div class="points" style="text-align: center; color: #00254b; padding-bottom: 1ex;">
                            <div class="number">0</div>
                            <div>Story Points</div>
                        </div>

                        <div class="info" style="margin-left: 95pt;">

                            <h4>Technologies</h4>
                            <div class="technologies" style="overflow: auto"><!-- "auto" to contain all the tags. -->
                                    <span class="label label-info" title="INFORMATIONAL">Decompiled Java File</span>
                            </div>



                            <div style="clear: both;"/><!-- Snaps under the height keeper. Yes, the same effect could be achieved by a table. -->
                        </div><!-- .info -->
                    </div>
                </div>



                <pre id="source">
package org.rhq.enterprise.server.cloud;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.NoResultException;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.jboss.annotation.IgnoreDependency;
import org.rhq.core.domain.cloud.AffinityGroup;
import org.rhq.core.domain.cloud.FailoverList;
import org.rhq.core.domain.cloud.FailoverListDetails;
import org.rhq.core.domain.cloud.PartitionEvent;
import org.rhq.core.domain.cloud.PartitionEventDetails;
import org.rhq.core.domain.cloud.Server;
import org.rhq.core.domain.cloud.composite.FailoverListComposite;
import org.rhq.core.domain.cloud.composite.FailoverListDetailsComposite;
import org.rhq.core.domain.cloud.composite.FailoverListComposite.ServerEntry;
import org.rhq.core.domain.resource.Agent;
import org.rhq.enterprise.server.cloud.CloudManagerLocal;
import org.rhq.enterprise.server.cloud.FailoverListManagerLocal;
import org.rhq.enterprise.server.cloud.ServerBucket;
import org.rhq.enterprise.server.core.AgentManagerLocal;

@Stateless
public class FailoverListManagerBean implements FailoverListManagerLocal {
   private final Log log = LogFactory.getLog(FailoverListManagerBean.class);
   private static final double ACCEPTABLE_DISPARITY = 0.1D;
   @PersistenceContext(
      unitName = &quot;rhqpu&quot;
   )
   private EntityManager entityManager;
   @EJB
   @IgnoreDependency
   CloudManagerLocal cloudManager;
   @EJB
   AgentManagerLocal agentManager;
   @EJB
   FailoverListManagerLocal failoverListManager;

   public FailoverListComposite getExistingForSingleAgent(String agentName) {
      Agent agent = this.agentManager.getAgentByName(agentName);
      if(null == agent) {
         throw new IllegalArgumentException(&quot;No agent found for registration name: &quot; + agentName);
      } else {
         return this.doGetExistingForSingleAgent(agent);
      }
   }

   private FailoverListComposite doGetExistingForSingleAgent(Agent agent) {
      FailoverListComposite result = null;
      Query query = this.entityManager.createNamedQuery(&quot;FailoverList.getViaAgent&quot;);
      query.setParameter(&quot;agent&quot;, agent);

      try {
         FailoverList e = (FailoverList)query.getSingleResult();
         ArrayList serverEntries = new ArrayList();
         Iterator i$ = e.getServerList().iterator();

         while(i$.hasNext()) {
            FailoverListDetails next = (FailoverListDetails)i$.next();
            serverEntries.add(next.getServer().getServerEntry());
         }

         result = new FailoverListComposite(serverEntries);
      } catch (NoResultException var8) {
         result = null;
      }

      return result;
   }

   public FailoverListComposite getForSingleAgent(PartitionEvent event, String agentName) {
      Agent agent = this.agentManager.getAgentByName(agentName);
      if(null == agent) {
         throw new IllegalArgumentException(&quot;No agent found for registration name: &quot; + agentName);
      } else {
         FailoverListComposite result = this.doGetExistingForSingleAgent(agent);
         if(null == result) {
            result = this.generateServerList(event, agent);
         }

         return result;
      }
   }

   private FailoverListComposite generateServerList(PartitionEvent event, Agent agent) {
      List servers = this.cloudManager.getAllCloudServers();
      ArrayList agents = new ArrayList(1);
      agents.add(agent);
      Query query = this.entityManager.createNamedQuery(&quot;FailoverListDetails.getAssignedLoads&quot;);
      List existingLoads = query.getResultList();
      Map agentServerListMap = this.getForAgents(event, servers, agents, existingLoads);
      this.persistComposites(event, agentServerListMap);
      return (FailoverListComposite)agentServerListMap.get(agent);
   }

   public Map refresh(PartitionEvent event) {
      List servers = this.cloudManager.getAllCloudServers();
      List agents = this.agentManager.getAllAgents();
      Map agentServerListMap = this.getForAgents(event, servers, agents, (List)null);
      this.clear();
      this.persistComposites(event, agentServerListMap);
      return agentServerListMap;
   }

   public Map refresh(PartitionEvent event, List servers, List agents) {
      Map agentServerListMap = this.getForAgents(event, servers, agents, (List)null);
      Iterator i$ = agents.iterator();

      while(i$.hasNext()) {
         Agent next = (Agent)i$.next();
         this.deleteServerListsForAgent(next);
      }

      this.persistComposites(event, agentServerListMap);
      return agentServerListMap;
   }

   private Map getForAgents(PartitionEvent event, List servers, List agents, List existingLoads) {
      HashMap result = new HashMap(agents.size());
      ArrayList buckets = new ArrayList(servers.size());
      Iterator agentServerListMap = servers.iterator();

      while(agentServerListMap.hasNext()) {
         Server i$ = (Server)agentServerListMap.next();
         buckets.add(new ServerBucket(i$));
      }

      HashMap var13 = new HashMap(agents.size());
      Iterator var14 = agents.iterator();

      Agent next;
      while(var14.hasNext()) {
         next = (Agent)var14.next();
         var13.put(next, new ArrayList(servers.size()));
      }

      ServerBucket bucket;
      for(int var15 = 0; var15 &lt; servers.size(); ++var15) {
         this.initBuckets(buckets, existingLoads, var15);
         Iterator var16 = agents.iterator();

         while(var16.hasNext()) {
            Agent serverEntries = (Agent)var16.next();
            List i$1 = (List)var13.get(serverEntries);
            bucket = null;
            Collections.rotate(buckets, 1);
            if(0 == var15 &amp;&amp; null != serverEntries.getServer()) {
               bucket = ServerBucket.getBestBucket(buckets, i$1, serverEntries.getAffinityGroup(), serverEntries.getServer().getName());
            } else {
               bucket = ServerBucket.getBestBucket(buckets, i$1, serverEntries.getAffinityGroup(), (String)null);
            }

            if(null == bucket) {
               this.log.error(&quot;Unexpected Condition! null bucket in getForAllAgents()&quot;);
            } else {
               i$1.add(bucket);
               bucket.assignedLoad += this.getAgentLoad(serverEntries) / (double)bucket.computePower;
               bucket.assignedAgents.add(serverEntries);
            }
         }

         if(this.balanceLoad(buckets, var13)) {
            ;
         }
      }

      var14 = var13.keySet().iterator();

      while(var14.hasNext()) {
         next = (Agent)var14.next();
         ArrayList var17 = new ArrayList(servers.size());
         Iterator var18 = ((List)var13.get(next)).iterator();

         while(var18.hasNext()) {
            bucket = (ServerBucket)var18.next();
            var17.add(bucket.serverEntry);
         }

         result.put(next, new FailoverListComposite(var17));
      }

      return result;
   }

   private void initBuckets(List buckets, List existingLoads, int level) {
      Iterator i$ = buckets.iterator();

      while(true) {
         while(true) {
            ServerBucket bucket;
            do {
               if(!i$.hasNext()) {
                  return;
               }

               bucket = (ServerBucket)i$.next();
               bucket.assignedLoad = 0.0D;
               bucket.assignedAgents.clear();
            } while(null == existingLoads);

            int serverId = bucket.server.getId();
            Iterator i$1 = existingLoads.iterator();

            while(i$1.hasNext()) {
               FailoverListDetailsComposite existingLoad = (FailoverListDetailsComposite)i$1.next();
               if(existingLoad.ordinal == level &amp;&amp; existingLoad.serverId == serverId) {
                  bucket.assignedLoad = (double)(existingLoad.assignedAgentCount / (long)bucket.computePower);
                  break;
               }
            }
         }
      }
   }

   private boolean balanceLoad(List buckets, Map agentServerListMap) {
      boolean done = false;
      boolean rebalanced = false;
      if(buckets.size() &lt; 2) {
         return false;
      } else {
         do {
            Collections.sort(buckets, new Comparator() {
               public int compare(ServerBucket bucket1, ServerBucket bucket2) {
                  return bucket2.assignedLoad &gt; bucket1.assignedLoad?1:-1;
               }
            });
            ServerBucket lowBucket = (ServerBucket)buckets.get(buckets.size() - 1);
            if(this.getLoadDisparity(Double.valueOf(((ServerBucket)buckets.get(0)).assignedLoad), Double.valueOf(lowBucket.assignedLoad)) &lt; 0.1D) {
               done = true;
            } else {
               Iterator i$ = buckets.iterator();

               while(i$.hasNext()) {
                  ServerBucket bucket = (ServerBucket)i$.next();
                  if(bucket == lowBucket) {
                     done = true;
                     break;
                  }

                  AffinityGroup affinityGroup = bucket.server.getAffinityGroup();
                  boolean checkAffinity = null != affinityGroup &amp;&amp; !affinityGroup.equals(lowBucket.server.getAffinityGroup());
                  int highIndex = -1;
                  double highLoad = 0.0D;
                  double load = 0.0D;
                  int agent = 0;

                  for(int size = bucket.assignedAgents.size(); agent &lt; size; ++agent) {
                     Agent agent1 = (Agent)bucket.assignedAgents.get(agent);
                     if((!checkAffinity || !affinityGroup.equals(agent1.getAffinityGroup())) &amp;&amp; !((List)agentServerListMap.get(agent1)).contains(lowBucket)) {
                        load = this.getAgentLoad(agent1);
                        if(load &gt; highLoad &amp;&amp; lowBucket.assignedLoad + load &lt;= bucket.assignedLoad - load) {
                           highIndex = agent;
                           highLoad = load;
                        }
                     }
                  }

                  if(highIndex &gt; -1) {
                     Agent var18 = (Agent)bucket.assignedAgents.remove(highIndex);
                     lowBucket.assignedAgents.add(var18);
                     ((List)agentServerListMap.get(var18)).remove(bucket);
                     ((List)agentServerListMap.get(var18)).add(lowBucket);
                     lowBucket.assignedLoad += highLoad;
                     bucket.assignedLoad -= highLoad;
                     rebalanced = true;
                     break;
                  }
               }
            }
         } while(!done);

         return rebalanced;
      }
   }

   private double getLoadDisparity(Double highLoad, Double lowLoad) {
      return (highLoad.doubleValue() - lowLoad.doubleValue()) / highLoad.doubleValue();
   }

   private double getAgentLoad(Agent agent) {
      return null == agent?0.0D:1.0D;
   }

   private void logServerList(String debugTitle, Map agentServerListMap) {
      StringBuilder sb = new StringBuilder(&quot;\nServerList (&quot;);
      sb.append(debugTitle);
      sb.append(&quot;) :&quot;);
      Iterator i$ = agentServerListMap.keySet().iterator();

      while(i$.hasNext()) {
         Agent agent = (Agent)i$.next();
         sb.append(&quot;\n\n Agent: &quot; + agent.getName());
         Iterator i$1 = ((List)agentServerListMap.get(agent)).iterator();

         while(i$1.hasNext()) {
            ServerBucket bucket = (ServerBucket)i$1.next();
            sb.append(&quot;\n   &quot;);
            sb.append(bucket.assignedLoad);
            sb.append(&quot; : &quot;);
            sb.append(bucket.server.getName());
         }
      }

      sb.append(&quot;\n\n&quot;);
      System.out.println(sb.toString());
      this.log.info(sb.toString());
   }

   public void deleteServerListsForAgent(Agent agent) {
      Query query1 = this.entityManager.createNamedQuery(&quot;FailoverListDetails.deleteViaAgent&quot;);
      Query query2 = this.entityManager.createNamedQuery(&quot;FailoverList.deletViaAgent&quot;);
      query1.setParameter(&quot;agent&quot;, agent);
      query2.setParameter(&quot;agent&quot;, agent);
      query1.executeUpdate();
      query2.executeUpdate();
   }

   public void deleteServerListDetailsForServer(int serverId) {
      Query query = this.entityManager.createNamedQuery(&quot;FailoverListDetails.deleteViaServer&quot;);
      query.setParameter(&quot;serverId&quot;, Integer.valueOf(serverId));
      query.executeUpdate();
   }

   private void clear() {
      Query query = this.entityManager.createNamedQuery(&quot;FailoverListDetails.truncate&quot;);
      query.executeUpdate();
      query = this.entityManager.createNamedQuery(&quot;FailoverList.truncate&quot;);
      query.executeUpdate();
   }

   private void persistComposites(PartitionEvent event, Map agentServerListMap) {
      FailoverList fl = null;
      FailoverListDetails failoverListDetails = null;
      PartitionEventDetails eventDetails = null;
      Iterator i$ = agentServerListMap.entrySet().iterator();

      while(i$.hasNext()) {
         Entry next = (Entry)i$.next();
         Agent nextAgent = (Agent)next.getKey();
         FailoverListComposite nextComposite = (FailoverListComposite)next.getValue();
         fl = new FailoverList(event, nextAgent);
         this.entityManager.persist(fl);
         boolean first = true;

         for(int i = 0; i &lt; nextComposite.size(); ++i) {
            ServerEntry serverEntry = nextComposite.get(i);
            Server server = (Server)this.entityManager.find(Server.class, Integer.valueOf(serverEntry.serverId));
            failoverListDetails = new FailoverListDetails(fl, i, server);
            this.entityManager.persist(failoverListDetails);
            if(first) {
               eventDetails = new PartitionEventDetails(event, nextAgent, server);
               this.entityManager.persist(eventDetails);
               first = false;
            }
         }
      }

   }
}
</pre>
            </div> <!-- /container -->
        </div><!-- /row-->
    </div><!-- /container main-->


<div style="text-align: left; font-size: small; color: gray; font-style: italic;">Page generated: Sep 8, 2017 11:31:15 AM</div>
    <script src="resources/js/jquery-1.10.1.min.js"></script>
    <script src="resources/js/jquery-migrate-1.4.1.min.js"></script>
    <script src="resources/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="resources/libraries/jquery-ui/jquery.ui.widget.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.min.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.java-properties.js"></script>
    <script type="text/javascript" src="resources/libraries/snippet/jquery.snippet.java-manifest.js"></script>
    <script type="text/javascript" src="resources/libraries/sausage/jquery.sausage.min.js"></script>

    <script type="text/javascript">
        var script   = document.createElement("script");
        script.type  = "text/javascript";
            script.src   = "resources/js/navbar.js";
        document.body.appendChild(script);
    </script>

    <script type="text/javascript">
        $(window).on("hashchange", function () {
            window.scrollTo(window.scrollX, window.scrollY - 50);
        });
        function offsetAnchor() {
            if(location.hash.length !== 0) {
                window.scrollTo(window.scrollX, window.scrollY - 50);
            }
        }
        window.setTimeout(function() {
            offsetAnchor();
        }, 1);
        $(document).ready(function(){
            $("pre").snippet("java",{style:"ide-eclipse", showNum:true,boxFill:"#ffeeb9", box: "" });




            $('code[class]').each(function(){
                 var codeSyntax = ($(this).attr('class'));
                 if(codeSyntax) {
                    $(this).parent().snippet(codeSyntax,{style:'ide-eclipse', menu:false, showNum:false});
                 }
            });
            $(window).sausage({ page: 'li.box' });
        });

        function qs(key) {
            key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
            var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
            return match && decodeURIComponent(match[1].replace(/\+/g, " "));
        }

        $(document).ready(function() {
            var defaultProjectID = 4062208;
            var selectedProject = qs("project");
            if (!selectedProject)
                selectedProject = defaultProjectID;

            $(".project-specific").each(function(index, element) {
                var currentProject = $(element).data("project-id");

                if (currentProject == selectedProject)
                    $(element).show();
                else
                    $(element).remove();
            });
            $("#main-navbar").show();
        });
    </script>

</body>
</html>
